---------------------------------------------------------------------------------------------------
-- TRIGGERS

CREATE OR REPLACE FUNCTION update_inventory()
RETURNS TRIGGER AS $$
BEGIN
    -- Disminuir el stock del producto basado en la cantidad insertada en detalle_orden
    UPDATE producto
    SET stock = stock - NEW.cantidad
    WHERE id_producto = NEW.id_producto;

    -- Verificar si el stock no se vuelve negativo
    IF (SELECT stock FROM producto WHERE id_producto = NEW.id_producto) < 0 THEN
        RAISE EXCEPTION 'Stock insuficiente para el producto ID: %', NEW.id_producto;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER after_insert_detalle_orden
AFTER INSERT ON detalle_orden
FOR EACH ROW
EXECUTE FUNCTION update_inventory();
